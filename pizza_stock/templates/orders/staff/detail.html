{% extends 'base.html' %} {% block title %}Order #{{ order.order_number }} -
Pizza Stock Management{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">
          <i class="fas fa-shopping-cart mr-2"></i>
          Order #{{ order.order_number }}
        </h1>
        <p class="mt-2 text-sm text-gray-600">
          {{ order.created_at|date:"F d, Y H:i" }}
        </p>
      </div>
      <span
        class="px-4 py-2 inline-flex text-lg leading-5 font-semibold rounded-full {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800 {% elif order.status == 'paid' %}bg-green-100 text-green-800 {% elif order.status == 'preparing' %}bg-blue-100 text-blue-800 {% elif order.status == 'ready' %}bg-purple-100 text-purple-800 {% elif order.status == 'completed' %}bg-gray-100 text-gray-800 {% elif order.status == 'cancelled' %}bg-red-100 text-red-800 {% endif %}"
      >
        {{ order.get_status_display }}
      </span>
    </div>
  </div>

  <!-- Customer Information -->
  <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
      <i class="fas fa-user mr-2"></i>
      Customer Information
    </h2>
    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <dt class="text-sm font-medium text-gray-500">Name</dt>
        <dd class="mt-1 text-sm text-gray-900">
          {{ order.customer_name|default:"Walk-in Customer" }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Phone</dt>
        <dd class="mt-1 text-sm text-gray-900">
          {{ order.customer_phone|default:"-" }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Table Number</dt>
        <dd class="mt-1 text-sm text-gray-900">
          {{ order.table_number|default:"-" }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Branch</dt>
        <dd class="mt-1 text-sm text-gray-900">{{ order.branch.name }}</dd>
      </div>
    </dl>
    {% if order.notes %}
    <div class="mt-4 pt-4 border-t border-gray-200">
      <dt class="text-sm font-medium text-gray-500 mb-2">
        Special Instructions
      </dt>
      <dd class="text-sm text-gray-900 bg-gray-50 p-3 rounded">
        {{ order.notes }}
      </dd>
    </div>
    {% endif %}
  </div>

  <!-- Order Items -->
  <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
      <i class="fas fa-list mr-2"></i>
      Order Items
    </h2>
    <div class="space-y-4">
      {% for item in order.items.all %}
      <div class="flex items-center justify-between border-b pb-4">
        <div class="flex items-center flex-1">
          <div
            class="h-16 w-16 rounded-lg bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center"
          >
            <i class="fas fa-pizza-slice text-white text-xl"></i>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-900">
              {{ item.sku.name }}
            </h3>
            <p class="text-xs text-gray-500">
              ₱{{ item.unit_price }} × {{ item.quantity }}
            </p>
            {% if item.notes %}
            <p class="text-xs text-gray-600 mt-1">
              <i class="fas fa-sticky-note mr-1"></i>{{ item.notes }}
            </p>
            {% endif %}
          </div>
        </div>
        <span class="text-lg font-bold text-gray-900"
          >₱{{ item.get_total }}</span
        >
      </div>
      {% endfor %}
    </div>

    <div class="mt-6 space-y-2">
      <div class="flex justify-between text-sm text-gray-600">
        <span>Subtotal</span>
        <span class="font-semibold">₱{{ order.subtotal }}</span>
      </div>
      <div class="flex justify-between text-sm text-gray-600">
        <span>Tax (12%)</span>
        <span class="font-semibold">₱{{ order.tax }}</span>
      </div>
      <div
        class="border-t pt-2 flex justify-between text-xl font-bold text-gray-900"
      >
        <span>Total</span>
        <span class="text-indigo-600">₱{{ order.total_amount }}</span>
      </div>
    </div>
  </div>

  <!-- Payment Information -->
  <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
      <i class="fas fa-credit-card mr-2"></i>
      Payment Information
    </h2>
    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <dt class="text-sm font-medium text-gray-500">Payment Method</dt>
        <dd class="mt-1 text-sm text-gray-900">
          <i
            class="fas {% if order.payment_method == 'counter' %}fa-cash-register{% elif order.payment_method == 'gcash' %}fa-mobile-alt{% else %}fa-credit-card{% endif %} mr-2"
          ></i>
          {{ order.get_payment_method_display }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Payment Status</dt>
        <dd class="mt-1 text-sm text-gray-900">
          {% if order.paid_at %}
          <span class="text-green-600 font-semibold">
            <i class="fas fa-check-circle mr-1"></i>
            Paid on {{ order.paid_at|date:"M d, Y H:i" }}
          </span>
          {% else %}
          <span class="text-yellow-600 font-semibold">
            <i class="fas fa-clock mr-1"></i>
            Pending Payment
          </span>
          {% endif %}
        </dd>
      </div>
      {% if order.payment_reference %}
      <div class="md:col-span-2">
        <dt class="text-sm font-medium text-gray-500">Reference Number</dt>
        <dd class="mt-1 text-sm text-gray-900 font-mono">
          {{ order.payment_reference }}
        </dd>
      </div>
      {% endif %}
    </dl>
  </div>

  <!-- Actions -->
  {% if user.is_manager %}
  <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
      <i class="fas fa-tasks mr-2"></i>
      Actions
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% if order.status == 'pending' %}
      <button
        onclick="updateStatus({{ order.id }}, 'paid')"
        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
      >
        <i class="fas fa-check mr-2"></i> Mark as Paid
      </button>
      {% endif %} {% if order.status == 'paid' %}
      <button
        onclick="updateStatus({{ order.id }}, 'preparing')"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
      >
        <i class="fas fa-fire mr-2"></i> Start Preparing
      </button>
      {% endif %} {% if order.status == 'preparing' %}
      <button
        onclick="updateStatus({{ order.id }}, 'ready')"
        class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
      >
        <i class="fas fa-bell mr-2"></i> Mark as Ready
      </button>
      {% endif %} {% if order.status == 'ready' %}
      <button
        onclick="updateStatus({{ order.id }}, 'completed')"
        class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold"
      >
        <i class="fas fa-check-circle mr-2"></i> Complete Order
      </button>
      {% endif %} {% if order.can_cancel %}
      <a
        href="{% url 'orders:cancel' order.id %}"
        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-center"
      >
        <i class="fas fa-times mr-2"></i> Cancel Order
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="flex space-x-4">
    <a
      href="{% url 'orders:dashboard' %}"
      class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 font-semibold text-center"
    >
      <i class="fas fa-arrow-left mr-2"></i> Back to Orders
    </a>
    <button
      onclick="window.print()"
      class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-semibold"
    >
      <i class="fas fa-print mr-2"></i> Print Receipt
    </button>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function updateStatus(orderId, newStatus) {
    const csrftoken = getCookie("csrftoken");

    fetch(`/orders/${orderId}/update-status/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken,
      },
      body: `status=${newStatus}`,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Failed to update order status");
      });
  }
</script>
{% endblock %}
