{% extends 'base.html' %}

{% block title %}Point of Sale - Pizza Stock Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-cash-register mr-2"></i>
                    Point of Sale
                </h1>
                <p class="mt-2 text-sm text-gray-600">
                    {{ request.current_branch.name }}
                </p>
            </div>
            <a href="{% url 'sales:dashboard' %}" 
               class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i> Back to Sales
            </a>
        </div>
    </div>

    <!-- Today's Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white shadow-lg rounded-lg p-4">
            <div class="flex items-center">
                <div class="bg-green-500 rounded-md p-3">
                    <i class="fas fa-dollar-sign text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Today's Revenue</p>
                    <p class="text-2xl font-bold text-gray-900">₱{{ today_sales.total_revenue|floatformat:2|default:"0.00" }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white shadow-lg rounded-lg p-4">
            <div class="flex items-center">
                <div class="bg-blue-500 rounded-md p-3">
                    <i class="fas fa-receipt text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Orders</p>
                    <p class="text-2xl font-bold text-gray-900">{{ today_sales.total_orders|default:"0" }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white shadow-lg rounded-lg p-4">
            <div class="flex items-center">
                <div class="bg-purple-500 rounded-md p-3">
                    <i class="fas fa-pizza-slice text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Items Sold</p>
                    <p class="text-2xl font-bold text-gray-900">{{ today_sales.total_items|default:"0" }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Menu Items -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-list mr-2"></i>
                    Menu Items
                </h2>

                <!-- Search Bar -->
                <div class="mb-4">
                    <input type="text" id="searchMenu" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                           placeholder="Search menu items...">
                </div>

                <!-- Categories Tabs -->
                <div class="mb-4 overflow-x-auto">
                    <div class="inline-flex space-x-2">
                        <button onclick="filterCategory('all')" 
                                class="category-filter px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                                data-category="all">
                            All Items
                        </button>
                        {% for category in categories %}
                        <button onclick="filterCategory('{{ category.id }}')" 
                                class="category-filter px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                                data-category="{{ category.id }}">
                            {{ category.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Menu Grid -->
                <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto">
                    {% for category in categories %}
                        {% for sku in category.skus.all %}
                        <div class="menu-item border-2 border-gray-200 rounded-lg p-4 hover:border-indigo-500 cursor-pointer transition"
                             data-category="{{ category.id }}"
                             data-name="{{ sku.name|lower }}"
                             onclick="addToCart({{ sku.id }}, '{{ sku.name|escapejs }}', {{ sku.price }})">
                            <div class="h-20 bg-gradient-to-br from-orange-400 to-red-500 rounded-lg flex items-center justify-center mb-3">
                                {% if sku.image %}
                                <img src="{{ sku.image.url }}" alt="{{ sku.name }}" class="h-full w-full object-cover rounded-lg">
                                {% else %}
                                <i class="fas fa-pizza-slice text-white text-3xl"></i>
                                {% endif %}
                            </div>
                            <h3 class="font-semibold text-gray-900 text-sm truncate">{{ sku.name }}</h3>
                            <p class="text-xs text-gray-500">{{ category.name }}</p>
                            <p class="text-lg font-bold text-indigo-600 mt-2">₱{{ sku.price }}</p>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right: Cart & Checkout -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow-lg rounded-lg p-6 sticky top-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Current Order
                </h2>

                <!-- Cart Items -->
                <div id="cartItems" class="space-y-3 mb-4 max-h-[300px] overflow-y-auto">
                    <p class="text-gray-500 text-center py-8 text-sm">Cart is empty</p>
                </div>

                <!-- Total -->
                <div class="border-t pt-4 mb-4">
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span id="subtotal">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Tax (12%)</span>
                            <span id="tax">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-900 border-t pt-2">
                            <span>Total</span>
                            <span id="total" class="text-indigo-600">₱0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Info (Optional) -->
                <div class="mb-4 space-y-2">
                    <input type="text" id="customerName" 
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                           placeholder="Customer name (optional)">
                    <input type="tel" id="customerPhone" 
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                           placeholder="Phone (optional)">
                    <input type="text" id="tableNumber" 
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                           placeholder="Table # (optional)">
                </div>

                <!-- Actions -->
                <div class="space-y-2">
                    <button onclick="processOrder()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold transition">
                        <i class="fas fa-check mr-2"></i>
                        Complete Order
                    </button>
                    <button onclick="clearCart()" 
                            class="w-full bg-red-100 text-red-700 py-2 rounded-lg hover:bg-red-200 transition">
                        <i class="fas fa-trash mr-2"></i>
                        Clear Cart
                    </button>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="bg-white shadow-lg rounded-lg p-4 mt-6">
                <h3 class="font-semibold text-gray-900 mb-3 text-sm">Recent Orders</h3>
                <div class="space-y-2">
                    {% for order in recent_orders %}
                    <div class="flex justify-between text-xs border-b pb-2">
                        <div>
                            <p class="font-semibold">#{{ order.order_number }}</p>
                            <p class="text-gray-500">{{ order.created_at|date:"H:i" }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-indigo-600">₱{{ order.total_amount }}</p>
                            <span class="px-2 py-0.5 text-xs rounded-full
                                {% if order.status == 'completed' %}bg-green-100 text-green-800
                                {% elif order.status == 'paid' %}bg-blue-100 text-blue-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center text-xs">No recent orders</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cart = [];

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addToCart(skuId, skuName, price) {
    const existing = cart.find(item => item.sku_id === skuId);
    
    if (existing) {
        existing.quantity++;
    } else {
        cart.push({
            sku_id: skuId,
            name: skuName,
            price: parseFloat(price),
            quantity: 1
        });
    }
    
    updateCartDisplay();
}

function removeFromCart(skuId) {
    cart = cart.filter(item => item.sku_id !== skuId);
    updateCartDisplay();
}

function updateQuantity(skuId, delta) {
    const item = cart.find(item => item.sku_id === skuId);
    if (item) {
        item.quantity += delta;
        if (item.quantity <= 0) {
            removeFromCart(skuId);
        } else {
            updateCartDisplay();
        }
    }
}

function updateCartDisplay() {
    const cartContainer = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        cartContainer.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm">Cart is empty</p>';
        document.getElementById('subtotal').textContent = '₱0.00';
        document.getElementById('tax').textContent = '₱0.00';
        document.getElementById('total').textContent = '₱0.00';
        return;
    }
    
    let html = '';
    let subtotal = 0;
    
    cart.forEach(item => {
        const lineTotal = item.price * item.quantity;
        subtotal += lineTotal;
        
        html += `
            <div class="flex items-center justify-between border-b pb-2">
                <div class="flex-1">
                    <p class="font-semibold text-sm text-gray-900">${item.name}</p>
                    <p class="text-xs text-gray-500">₱${item.price.toFixed(2)} each</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="updateQuantity(${item.sku_id}, -1)" 
                            class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="font-semibold text-sm px-2">${item.quantity}</span>
                    <button onclick="updateQuantity(${item.sku_id}, 1)" 
                            class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button onclick="removeFromCart(${item.sku_id})" 
                            class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartContainer.innerHTML = html;
    
    const tax = subtotal * 0.12;
    const total = subtotal + tax;
    
    document.getElementById('subtotal').textContent = '₱' + subtotal.toFixed(2);
    document.getElementById('tax').textContent = '₱' + tax.toFixed(2);
    document.getElementById('total').textContent = '₱' + total.toFixed(2);
}

function clearCart() {
    if (cart.length === 0) return;
    if (confirm('Clear entire cart?')) {
        cart = [];
        updateCartDisplay();
    }
}

async function processOrder() {
    if (cart.length === 0) {
        alert('Cart is empty!');
        return;
    }
    
    const orderData = {
        items: cart,
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        table_number: document.getElementById('tableNumber').value,
        payment_method: 'counter',
        notes: ''
    };
    
    try {
        const response = await fetch('{% url "sales:pos_create_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`✅ Order #${data.order_number} completed!\nTotal: ₱${data.total_amount.toFixed(2)}`);
            
            // Open receipt in new window
            if (confirm('Print receipt?')) {
                window.open(data.receipt_url, '_blank', 'width=400,height=600');
            }
            
            cart = [];
            updateCartDisplay();
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('tableNumber').value = '';
            
            // Reload to update today's stats
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('❌ Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to process order');
    }
}

// Search functionality
document.getElementById('searchMenu').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.menu-item').forEach(item => {
        const name = item.dataset.name;
        item.style.display = name.includes(query) ? 'block' : 'none';
    });
});

// Category filter
function filterCategory(categoryId) {
    // Update button styles
    document.querySelectorAll('.category-filter').forEach(btn => {
        if (btn.dataset.category === categoryId) {
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            btn.classList.add('bg-indigo-600', 'text-white');
        } else {
            btn.classList.remove('bg-indigo-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        }
    });
    
    // Filter items
    document.querySelectorAll('.menu-item').forEach(item => {
        if (categoryId === 'all' || item.dataset.category === categoryId) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}
// Keyboard shortcuts for POS
document.addEventListener('keydown', function(e) {
    // F1 - Complete Order
    if (e.key === 'F1') {
        e.preventDefault();
        if (cart.length > 0) {
            processOrder();
        }
    }
    
    // F2 - Clear Cart
    if (e.key === 'F2') {
        e.preventDefault();
        clearCart();
    }
    
    // Escape - Focus search
    if (e.key === 'Escape') {
        e.preventDefault();
        document.getElementById('searchMenu').focus();
    }
});

// Show keyboard shortcuts hint
console.log('POS Keyboard Shortcuts:');
console.log('F1 - Complete Order');
console.log('F2 - Clear Cart');
console.log('ESC - Focus Search');
</script>
{% endblock %}