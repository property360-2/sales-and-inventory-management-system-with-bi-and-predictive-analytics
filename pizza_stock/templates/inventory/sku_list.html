{% extends 'base.html' %}

{% block title %}All SKUs - Pizza Stock Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-8 flex justify-between items-center flex-wrap gap-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">
        <i class="fas fa-pizza-slice mr-2"></i>
        All Menu Items (SKUs)
      </h1>
      <p class="mt-2 text-sm text-gray-600">
        Browse all available pizza and menu items
      </p>
    </div>

    {% if user.is_manager %}
    <a
      href="{% url 'inventory:add_sku' %}"
      class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-semibold shadow-lg transition transform hover:scale-105"
    >
      <i class="fas fa-plus mr-2"></i>
      Create New Item
    </a>
    {% endif %}
  </div>

  <!-- Search & Filter -->
  <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <form id="filterForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <input
          type="text"
          name="q"
          id="searchInput"
          placeholder="Search by name or description..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <div>
        <select
          name="category"
          id="categorySelect"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
        >
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-3">
        <button
          type="submit"
          class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
        >
          <i class="fas fa-search mr-2"></i> Search
        </button>
      </div>
    </form>
  </div>

  <!-- SKU Grid -->
  <div id="skuGrid">
    {% include 'inventory/partials/sku_grid.html' %}
  </div>
</div>

<!-- Async JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("skuGrid");
  const searchInput = document.getElementById("searchInput");
  const categorySelect = document.getElementById("categorySelect");
  const form = document.getElementById("filterForm");

  // Debounce to limit requests while typing
  function debounce(func, wait = 300) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Fetch filtered data
  async function fetchFilteredData() {
    const params = new URLSearchParams({
      q: searchInput.value,
      category: categorySelect.value
    });

    try {
      const response = await fetch(`?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      const data = await response.text();
      grid.innerHTML = data;
      attachPaginationListeners(); // re-bind pagination links
    } catch (err) {
      console.error("Error fetching data:", err);
    }
  }

  // Fetch from pagination URL
  async function fetchFilteredDataFromURL(url) {
    try {
      const response = await fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      const data = await response.text();
      grid.innerHTML = data;
      attachPaginationListeners();
    } catch (err) {
      console.error("Error fetching pagination:", err);
    }
  }

  // Bind pagination links
  function attachPaginationListeners() {
    document.querySelectorAll("#skuGrid a.page-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        fetchFilteredDataFromURL(link.href);
      });
    });
  }

  // Form submission (button click)
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    fetchFilteredData();
  });

  // Live search
  searchInput.addEventListener("input", debounce(fetchFilteredData, 300));

  // Category change
  categorySelect.addEventListener("change", fetchFilteredData);

  // Initial pagination binding
  attachPaginationListeners();
});
</script>
{% endblock %}
